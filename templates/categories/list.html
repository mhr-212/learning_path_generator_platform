{% extends 'base/base.html' %}

{% block title %}Categories - Learning Path Generator{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="mb-0">Course Categories</h1>
            <p class="lead text-muted">Browse courses by category.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                <i class="fas fa-plus-circle me-2"></i>Add New Category
            </button>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="input-group">
                <input type="text" id="search-input" class="form-control" placeholder="Search categories...">
                <button class="btn btn-primary" type="button" id="search-button">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    </div>
    
    <div id="categories-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <!-- Categories will be loaded here -->
    </div>
    
    <div id="pagination-controls" class="d-flex justify-content-center mt-4">
        <button class="btn btn-outline-primary me-2" id="prev-page" disabled>Previous</button>
        <span class="align-self-center" id="page-info">Page 1 of 1</span>
        <button class="btn btn-outline-primary ms-2" id="next-page" disabled>Next</button>
    </div>
    
    <div id="loading-spinner" class="text-center mt-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading categories...</p>
    </div>
    
    <div id="no-results" class="text-center mt-5" style="display: none;">
        <p class="lead text-muted">No categories found matching your criteria.</p>
    </div>
</div>

<!-- Create/Edit Category Modal -->
<div class="modal fade" id="createCategoryModal" tabindex="-1" aria-labelledby="createCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createCategoryModalLabel">Create New Category</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    <div class="mb-3">
                        <label for="category-name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="category-name-input" required>
                    </div>
                    <div class="mb-3">
                        <label for="category-description" class="form-label">Description</label>
                        <textarea class="form-control" id="category-description-input" rows="3"></textarea>
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;

document.addEventListener("DOMContentLoaded", function() {
    loadCategories();
    
    document.getElementById("search-button").addEventListener("click", function() {
        currentPage = 1;
        loadCategories();
    });
    
    document.getElementById("search-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            currentPage = 1;
            loadCategories();
        }
    });
    
    document.getElementById("prev-page").addEventListener("click", function() {
        if (currentPage > 1) {
            currentPage--;
            loadCategories();
        }
    });
    
    document.getElementById("next-page").addEventListener("click", function() {
        if (currentPage < totalPages) {
            currentPage++;
            loadCategories();
        }
    });
    
    // Modal related event listeners
    const createCategoryModal = document.getElementById("createCategoryModal");
    createCategoryModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget; // Button that triggered the modal
        const categoryId = button ? button.getAttribute("data-category-id") : null; // Extract info from data-category-id attribute
        
        resetCategoryForm();
        if (categoryId) {
            document.getElementById("createCategoryModalLabel").textContent = "Edit Category";
            loadCategoryForEdit(categoryId);
        } else {
            document.getElementById("createCategoryModalLabel").textContent = "Create New Category";
        }
    });
    
    document.getElementById("category-form").addEventListener("submit", handleCategorySubmit);
});

async function loadCategories() {
    const search = document.getElementById("search-input").value;
    
    const params = {
        page: currentPage,
        search: search,
        ordering: "name"
    };
    
    showLoading("categories-list");
    const result = await api.getCategories(params);
    hideLoading("categories-list");
    
    const categoriesList = document.getElementById("categories-list");
    const noResults = document.getElementById("no-results");
    
    if (result.success && result.data.results.length > 0) {
        categoriesList.innerHTML = result.data.results.map(category => createCategoryCard(category)).join("");
        totalPages = Math.ceil(result.data.count / 20); // Assuming page_size is 20
        updatePaginationControls();
        noResults.style.display = "none";
        categoriesList.style.display = "flex";
    } else {
        categoriesList.innerHTML = "";
        noResults.style.display = "block";
        categoriesList.style.display = "none";
        totalPages = 1;
        updatePaginationControls();
    }
}

function updatePaginationControls() {
    document.getElementById("page-info").textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById("prev-page").disabled = currentPage === 1;
    document.getElementById("next-page").disabled = currentPage === totalPages;
}

function resetCategoryForm() {
    document.getElementById("category-form").reset();
    document.getElementById("category-id").value = "";
}

async function loadCategoryForEdit(categoryId) {
    const result = await api.getCategory(categoryId);
    if (result.success) {
        const category = result.data;
        document.getElementById("category-id").value = category.id;
        document.getElementById("category-name-input").value = category.name;
        document.getElementById("category-description-input").value = category.description;
    } else {
        showToast("Error loading category for edit: " + getErrorMessage(result.error), "danger");
    }
}

async function handleCategorySubmit(event) {
    event.preventDefault();
    showLoading("category-form");
    
    const categoryId = document.getElementById("category-id").value;
    const data = {
        name: document.getElementById("category-name-input").value,
        description: document.getElementById("category-description-input").value,
    };
    
    let result;
    if (categoryId) {
        result = await api.updateCategory(categoryId, data);
    } else {
        result = await api.createCategory(data);
    }
    
    if (result.success) {
        showToast(`Category ${categoryId ? \'updated\' : \'created\'} successfully!`, "success");
        bootstrap.Modal.getInstance(document.getElementById("createCategoryModal")).hide();
        loadCategories(); // Reload list
    } else {
        showToast(`Error ${categoryId ? \'updating\' : \'creating\'} category: ` + getErrorMessage(result.error), "danger");
    }
    hideLoading("category-form");
}

async function deleteCategory(categoryId) {
    if (confirm("Are you sure you want to delete this category? This action cannot be undone.")) {
        const result = await api.deleteCategory(categoryId);
        if (result.success) {
            showToast("Category deleted successfully!", "success");
            loadCategories();
        } else {
            showToast("Error deleting category: " + getErrorMessage(result.error), "danger");
        }
    }
}
</script>
{% endblock %}