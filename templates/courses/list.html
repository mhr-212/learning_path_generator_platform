{% extends 'base/base.html' %}

{% block title %}Courses - Learning Path Generator{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="mb-0">Browse Courses</h1>
            <p class="lead text-muted">Discover a wide range of courses from various platforms.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="/my-courses/" class="btn btn-outline-primary">
                <i class="fas fa-plus-circle me-2"></i>My Courses
            </a>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="input-group">
                <input type="text" id="search-input" class="form-control" placeholder="Search courses by title, instructor, or tags...">
                <button class="btn btn-primary" type="button" id="search-button">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-3">
            <select id="difficulty-filter" class="form-select">
                <option value="">All Difficulties</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>
        <div class="col-md-3">
            <select id="category-filter" class="form-select">
                <option value="">All Categories</option>
                <!-- Categories will be loaded dynamically -->
            </select>
        </div>
        <div class="col-md-3">
            <select id="sort-by" class="form-select">
                <option value="-created_at">Newest First</option>
                <option value="created_at">Oldest First</option>
                <option value="title">Title (A-Z)</option>
                <option value="-title">Title (Z-A)</option>
                <option value="price">Price (Low to High)</option>
                <option value="-price">Price (High to Low)</option>
                <option value="-rating">Highest Rated</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-secondary w-100" id="apply-filters-button">
                <i class="fas fa-filter me-2"></i>Apply Filters
            </button>
        </div>
    </div>
    
    <div id="courses-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <!-- Courses will be loaded here -->
    </div>
    
    <div id="pagination-controls" class="d-flex justify-content-center mt-4">
        <button class="btn btn-outline-primary me-2" id="prev-page" disabled>Previous</button>
        <span class="align-self-center" id="page-info">Page 1 of 1</span>
        <button class="btn btn-outline-primary ms-2" id="next-page" disabled>Next</button>
    </div>
    
    <div id="loading-spinner" class="text-center mt-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading courses...</p>
    </div>
    
    <div id="no-results" class="text-center mt-5" style="display: none;">
        <p class="lead text-muted">No courses found matching your criteria.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;

document.addEventListener("DOMContentLoaded", function() {
    loadCategories();
    loadCourses();
    
    document.getElementById("search-button").addEventListener("click", function() {
        currentPage = 1;
        loadCourses();
    });
    
    document.getElementById("search-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            currentPage = 1;
            loadCourses();
        }
    });
    
    document.getElementById("apply-filters-button").addEventListener("click", function() {
        currentPage = 1;
        loadCourses();
    });
    
    document.getElementById("prev-page").addEventListener("click", function() {
        if (currentPage > 1) {
            currentPage--;
            loadCourses();
        }
    });
    
    document.getElementById("next-page").addEventListener("click", function() {
        if (currentPage < totalPages) {
            currentPage++;
            loadCourses();
        }
    });
});

async function loadCategories() {
    const categoryFilter = document.getElementById("category-filter");
    const result = await api.getCategories();
    if (result.success) {
        result.data.results.forEach(category => {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = category.name;
            categoryFilter.appendChild(option);
        });
    } else {
        showToast("Error loading categories.", "danger");
    }
}

async function loadCourses() {
    const search = document.getElementById("search-input").value;
    const difficulty = document.getElementById("difficulty-filter").value;
    const category = document.getElementById("category-filter").value;
    const ordering = document.getElementById("sort-by").value;
    
    const params = {
        page: currentPage,
        search: search,
        difficulty_level: difficulty,
        category: category,
        ordering: ordering,
        is_public: true // Only show public courses on this page
    };
    
    showLoading("courses-list");
    const result = await api.getCourses(params);
    hideLoading("courses-list");
    
    const coursesList = document.getElementById("courses-list");
    const noResults = document.getElementById("no-results");
    
    if (result.success && result.data.results.length > 0) {
        coursesList.innerHTML = result.data.results.map(course => createCourseCard(course)).join("");
        totalPages = Math.ceil(result.data.count / 20); // Assuming page_size is 20
        updatePaginationControls();
        noResults.style.display = "none";
        coursesList.style.display = "flex";
    } else {
        coursesList.innerHTML = "";
        noResults.style.display = "block";
        coursesList.style.display = "none";
        totalPages = 1;
        updatePaginationControls();
    }
}

function updatePaginationControls() {
    document.getElementById("page-info").textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById("prev-page").disabled = currentPage === 1;
    document.getElementById("next-page").disabled = currentPage === totalPages;
}
</script>
{% endblock %}
